services:
  api:
    build:
      context: .
      dockerfile: Dockerfile
    env_file:
      - .env
    environment:
      - NODE_ENV=production
    command: >
      sh -c "npx prisma migrate deploy && npx prisma db seed && node dist/main"
    restart: unless-stopped
    networks:
      - mi-gestor-network
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:3000/health"]
      interval: 30s
      timeout: 5s
      retries: 3
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.migestor-api.rule=Host(`rest.dcmigestor.co`)"
      - "traefik.http.routers.migestor-api.entrypoints=websecure"
      - "traefik.http.routers.migestor-api.tls.certresolver=myresolver"
      - "traefik.http.services.migestor-api.loadbalancer.server.port=3000"

networks:
  mi-gestor-network:
    external: true
