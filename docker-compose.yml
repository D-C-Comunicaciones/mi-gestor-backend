services:
  api:
    build: .
    env_file:
      - .env
    environment:
      - NODE_ENV=production
      - REDIS_URL=${REDIS_URL}
      - RABBITMQ_URL=${RABBITMQ_URL}
    command: >
      sh -c "
      until nc -z -v -w5 migestor-redis-4sorwd-2d219a-206-189-65-31.traefik.me 6379; do sleep 2; done;
      until nc -z -v -w5 migestor-rabbitmq-3ca385-206-189-65-31.traefik.me 5672; do sleep 2; done;
      until nc -z -v -w5 db-mi-gestor-do-user-16535172-0.e.db.ondigitalocean.com 25060; do sleep 2; done;
      npx prisma migrate deploy && node dist/main
      "
    restart: unless-stopped
    networks:
      - mi-gestor-net
    ports:
      - "3000:3000"  # ðŸ”¥ expone la API al host

networks:
  mi-gestor-net:
    external: true
