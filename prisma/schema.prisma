generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// -------------------------------------
/// TABLAS AUXILIARES / CATÁLOGOS
/// -------------------------------------

model Zone {
  id       Int     @id @default(autoincrement()) // PK: identificador único de la zona
  name     String  @unique // Nombre de la zona (ej: Norte, Centro)
  code     String  @unique // Código corto de la zona (útil para integraciones)
  isActive Boolean @default(true) // Indica si la zona está activa (soft delete)

  collectors Collector[] // Rel: cobradores asignados a la zona
  customers  Customer[] // Rel: clientes asignados a la zona

  @@index([name])
  @@index([code])
  @@index([isActive])
  @@map("zones")
}

model TypeDocumentIdentification {
  id       Int     @id @default(autoincrement()) // PK: id del tipo de documento
  name     String  @unique // Nombre del tipo (CC, CE, NIT...)
  code     String  @unique // Código corto (ej: CC)
  isActive Boolean @default(true) // Activo/inactivo para administración

  customers  Customer[] // Rel: clientes que usan este tipo de documento
  collectors Collector[] // Rel: cobradores que usan este tipo de documento

  @@index([name])
  @@index([code])
  @@index([isActive])
  @@map("type_document_identifications")
}

model Gender {
  id       Int     @id @default(autoincrement()) // PK: id del género
  name     String  @unique // Nombre (Masculino, Femenino, Otro)
  code     String  @unique // Código corto
  isActive Boolean @default(true) // Activación/desactivación

  customers  Customer[] // Rel: clientes vinculados
  collectors Collector[] // Rel: cobradores vinculados

  @@index([name])
  @@index([code])
  @@index([isActive])
  @@map("genders")
}

model LoanType {
  id       Int     @id @default(autoincrement()) // PK: id del tipo de crédito
  name     String  @unique // Ej: CUOTA_FIJA, INTERES_MENSUAL (método)
  isActive Boolean @default(true) // Permite activar/desactivar tipos

  loans Loan[] // Créditos asociados a este tipo

  @@index([name])
  @@index([isActive])
  @@map("loan_types")
}

model PaymentFrequency {
  id       Int     @id @default(autoincrement()) // PK: id de frecuencia
  name     String  @unique // Ej: DAILY, WEEKLY, BIWEEKLY, MONTHLY
  isActive Boolean @default(true) // Activación para administrar frecuencias

  loans Loan[] // Créditos que usan esta frecuencia

  @@index([name])
  @@index([isActive])
  @@map("payment_frequencies")
}

model LoanStatus {
  id       Int     @id @default(autoincrement()) // PK: id del estado del crédito
  name     String  @unique // Ej: ACTIVO, CANCELADO, REFINANCIADO
  isActive Boolean @default(true) // Permite mantener catálogo dinámico

  loans Loan[] // Créditos en ese estado

  @@index([name])
  @@index([isActive])
  @@map("loan_statuses")
}

model PaymentType {
  id       Int     @id @default(autoincrement()) // PK: id tipo de pago
  name     String  @unique // Ej: CAPITAL, INTEREST, LATE_FEE, RENT
  isActive Boolean @default(true) // Control de catálogo

  payments Payment[] // Pagos registrados con ese tipo

  @@index([name])
  @@index([isActive])
  @@map("payment_types")
}

/// -------------------------------------
/// USUARIOS, ROLES Y PERMISOS
/// -------------------------------------

model User {
  id          Int          @id @default(autoincrement()) // PK: id del usuario del sistema
  email       String       @unique // Email único para login
  password    String // Contraseña hasheada
  name        String // Nombre del usuario (para auditoría)
  roleId      Int? // FK opcional a Role (control de acceso)
  role        Role?        @relation(fields: [roleId], references: [id])
  loginAudits LoginAudit[] // Historial de accesos
  customer    Customer?    @relation // Si el usuario también es un cliente del sistema
  collector   Collector?   @relation // Si el usuario también es cobrador
  isActive    Boolean      @default(true) // Usuario activo/inactivo

  // Relación para pagos registrados por este usuario (audit)
  paymentsRecorded Payment[] @relation("PaymentsRecordedByUser")

  @@index([email])
  @@index([roleId])
  @@index([isActive])
  @@map("users")
}

model Role {
  id              Int              @id @default(autoincrement()) // PK rol
  name            String           @unique // Nombre del rol (admin, collector,...)
  description     String? // Descripción del rol
  isActive        Boolean          @default(true) // Activación del rol
  rolePermissions RolePermission[] // Permisos asignados
  users           User[]

  @@index([name])
  @@index([isActive])
  @@map("roles")
}

model Permission {
  id              Int              @id @default(autoincrement()) // PK permiso
  name            String           @unique // Nombre (crear_cliente, ver_reportes...)
  description     String?
  isActive        Boolean          @default(true) // Activación del permiso
  rolePermissions RolePermission[] // Roles que contienen este permiso

  @@index([name])
  @@index([isActive])
  @@map("permissions")
}

model RolePermission {
  roleId       Int
  permissionId Int

  // FK y relaciones para tabla intermedia muchos-a-muchos
  role       Role       @relation(fields: [roleId], references: [id])
  permission Permission @relation(fields: [permissionId], references: [id])

  isActive Boolean @default(true) // Permite desactivar asociaciones sin borrarlas

  @@id([roleId, permissionId]) // PK compuesta
  @@index([roleId])
  @@index([permissionId])
  @@index([isActive])
  @@map("role_permissions")
}

model LoginAudit {
  id        Int      @id @default(autoincrement()) // PK auditoría de login
  userId    Int // FK al usuario que inició sesión
  sessionId String   @default("unknown") // Identificador de sesión (si hay)
  ip        String // IP desde donde se conectó
  device    String // User-agent / dispositivo
  location  String? // Ubicación opcional (geo)
  timestamp DateTime @default(now()) // Marca de tiempo del acceso

  user User @relation(fields: [userId], references: [id]) // Relación a User

  @@index([userId])
  @@index([timestamp])
  @@index([sessionId])
  @@map("logins")
}

model Change {
  id        Int      @id @default(autoincrement()) // PK: registro de cambios (audit trail)
  model     String // Nombre del modelo afectado (ej: "loan")
  modelId   Int // ID del registro afectado (ej: crédito específico)
  action    String // Acción (CREATE, UPDATE, DELETE)
  before    Json? // Estado anterior (JSON) - útil para revert/registro
  after     Json? // Estado posterior (JSON)
  timestamp DateTime @default(now()) // Fecha del cambio
  userId    Int // Usuario que realizó el cambio

  @@index([model])
  @@index([modelId])
  @@index([action])
  @@index([userId])
  @@index([timestamp])
  @@map("changes")
}

/// -------------------------------------
/// CUSTOMERS Y COBRADORES
/// -------------------------------------

model Customer {
  id        Int    @id @default(autoincrement()) // PK cobrador
  firstName String // Nombre
  lastName  String // Apellido

  typeDocumentIdentificationId Int // FK a tipo de documento
  typeDocumentIdentification   TypeDocumentIdentification @relation(fields: [typeDocumentIdentificationId], references: [id])

  genderId Int
  gender   Gender @relation(fields: [genderId], references: [id])

  documentNumber Int      @unique // Número de documento (único)
  birthDate      DateTime @db.Date // Fecha de nacimiento (opcional, pero útil para auditoría)
  address        String
  phone          String // Teléfono
  zoneId         Int? // FK opcional a Zone (si trabaja por zona)
  userId         Int?     @unique // FK opcional a User (si tiene cuenta)
  isActive       Boolean  @default(true) // Activación del cobrador

  // Relaciones
  zone Zone? @relation(fields: [zoneId], references: [id])
  user User? @relation(fields: [userId], references: [id])

  loans Loan[] // Créditos asociados a este customer

  @@index([firstName])
  @@index([lastName])
  @@index([zoneId])
  @@index([isActive])
  @@map("customers")
}

model Collector {
  id        Int    @id @default(autoincrement()) // PK cobrador
  firstName String // Nombre
  lastName  String // Apellido

  typeDocumentIdentificationId Int // FK a tipo de documento
  typeDocumentIdentification   TypeDocumentIdentification @relation(fields: [typeDocumentIdentificationId], references: [id])

  genderId Int
  gender   Gender @relation(fields: [genderId], references: [id])

  documentNumber Int      @unique // Número de documento (único)
  birthDate      DateTime @db.Date // Fecha de nacimiento (opcional, pero útil para auditoría)
  address        String
  phone          String // Teléfono
  zoneId         Int? // FK opcional a Zone (si trabaja por zona)
  userId         Int?     @unique // FK opcional a User (si tiene cuenta)
  isActive       Boolean  @default(true) // Activación del cobrador

  // Relaciones
  zone     Zone?     @relation(fields: [zoneId], references: [id])
  user     User?     @relation(fields: [userId], references: [id])
  payments Payment[] @relation("PaymentsCollectedByCollector") // Pagos que recoge este cobrador

  @@index([firstName])
  @@index([lastName])
  @@index([zoneId])
  @@index([isActive])
  @@map("collectors")
}

model InterestRate {
  id    Int     @id @default(autoincrement()) // PK
  value Decimal @db.Decimal(6, 4) // Tasa de interés (ej. 0.0500 => 5% anual o según convención)
  loan  Loan[]

  @@index([value])
  @@map("interest_rates")
}

model Term {
  id    Int    @id @default(autoincrement()) // PK
  value Int // Número de cuotas/plazos (si aplica)
  loan  Loan[]

  @@index([value])
  @@map("terms")
}

model PenaltyRate {
  id       Int      @id @default(autoincrement())
  name     String   // Ejemplo: "Interés moratorio legal máximo"
  value    Decimal  @db.Decimal(5, 4) // Ejemplo: 0.05 = 5% mensual o anual según config
  isActive Boolean  @default(true)

  loans Loan[] // 👈 Relación con créditos
  @@map("penalty_rates")
}

model MoratoryInterest {
  id            Int          @id @default(autoincrement())
  installmentId Int          @unique
  daysLate      Int
  amount        Float

  installment Installment @relation(fields: [installmentId], references: [id])

  @@index([installmentId, daysLate, amount])
  @@map("moratory_interests")
}

model GracePeriod {
  id     Int    @id @default(autoincrement())
  name   String // Ej: "15 días", "1 mes", "3 meses"
  days   Int    // Número de días del período de gracia
  isActive Boolean @default(true)

  loans Loan[] // Relación con los préstamos que usan este período

  @@index([days])
  @@map("grace_periods")
}


/// -------------------------------------
/// CRÉDITOS, CUOTAS, PAGOS Y REFINANCIACIONES
/// -------------------------------------

model Loan {
  id         Int      @id @default(autoincrement()) // PK crédito
  customerId Int
  customer   Customer @relation(fields: [customerId], references: [id])

  loanAmount       Decimal  @db.Decimal(10, 0) // Monto prestado original
  remainingBalance Decimal  @db.Decimal(10, 0) // Saldo actual (disminuye con abonos a capital)
  interestRateId   Int // FK → tabla InterestRate (interés del préstamo)
  penaltyRateId    Int? // FK → tabla PenaltyRate (tasa de interés moratorio)

  paymentAmount      Decimal? @db.Decimal(10, 0) // Valor de cuota fija (si aplica)
  termId             Int
  paymentFrequencyId Int // Frecuencia de pago (diario, semanal, mensual)
  loanTypeId         Int // Tipo de crédito (1 = Cuota fija, 2 = Solo intereses)
  loanStatusId       Int // Estado del crédito
  gracePeriodId      Int? // FK → tabla GracePeriod (plazo de gracia)

  // Relaciones
  interestRate     InterestRate     @relation(fields: [interestRateId], references: [id])
  penaltyRate      PenaltyRate?     @relation(fields: [penaltyRateId], references: [id])
  loanType         LoanType         @relation(fields: [loanTypeId], references: [id])
  loanStatus       LoanStatus       @relation(fields: [loanStatusId], references: [id])
  paymentFrequency PaymentFrequency @relation(fields: [paymentFrequencyId], references: [id])
  term             Term?             @relation(fields: [termId], references: [id])
  gracePeriod      GracePeriod?     @relation(fields: [gracePeriodId], references: [id])

  // Fechas clave
  startDate   DateTime  @db.Date // Fecha de inicio
  nextDueDate DateTime? @db.Date // Próxima fecha esperada de pago

  // Flags
  isActive Boolean @default(true)

  // Relaciones hijas
  installments         Installment[] // Cronograma de cuotas generadas
  payments             Payment[]     // Pagos realizados
  refinancingsOriginal Refinancing[] @relation("OriginalLoan")
  refinancingsNew      Refinancing[] @relation("NewLoan")

  @@index([customerId])
  @@index([paymentFrequencyId])
  @@index([loanTypeId])
  @@index([interestRateId])
  @@index([penaltyRateId])
  @@index([loanStatusId])
  @@index([startDate])
  @@index([isActive])
  @@map("loans")
}

/// -------------------------------------
/// TABLA DE CUOTAS (INSTALLMENTS)
/// -------------------------------------
model Installment {
  id             Int       @id @default(autoincrement()) // PK cuota (installment)
  loanId         Int // FK al crédito
  loan           Loan      @relation(fields: [loanId], references: [id])
  sequence       Int // Número de cuota en el cronograma (1..N)
  dueDate        DateTime  @db.Date// Fecha de vencimiento de esta cuota
  capitalAmount  Decimal   @db.Decimal(10, 0) // Porción de capital esperada
  interestAmount Decimal   @db.Decimal(10, 0) // Porción de interés esperada
  totalAmount    Decimal   @db.Decimal(10, 0) // capitalAmount + interestAmount (valor esperado)
  paidAmount     Decimal   @default(0) @db.Decimal(10, 0) // Acumulado pagado contra esta cuota
  isPaid         Boolean   @default(false) // Si la cuota está completamente pagada
  isActive       Boolean   @default(true) // Activación de la cuota (soft delete)
  paidAt         DateTime? // Fecha en la que se completó el pago total de la cuota

  payments Payment[] // Pagos aplicados a esta cuota (vínculo para trazabilidad)
  moratoryInterests MoratoryInterest[]

  @@index([loanId])
  @@index([dueDate])
  @@index([isPaid])
  @@map("installments")
}

model Payment {
  id            Int          @id @default(autoincrement()) // PK pago
  loanId        Int // FK al crédito afectado
  loan          Loan         @relation(fields: [loanId], references: [id])
  installmentId Int? // FK opcional a cuota si el pago se aplica a una cuota específica
  installment   Installment? @relation(fields: [installmentId], references: [id])

  amount        Decimal     @db.Decimal(10, 0) // Monto total del registro de pago
  paymentTypeId Int
  paymentType   PaymentType @relation(fields: [paymentTypeId], references: [id]) // Tipo (capital, interés, mora...)

  collectorId Int? // Cobrador que registró o recogió el pago (opcional)
  collector   Collector? @relation("PaymentsCollectedByCollector", fields: [collectorId], references: [id])

  date DateTime @default(now()) // Fecha en que se registró el pago

  // DESGLOSE: resultados de la lógica al aplicar el pago
  appliedToCapital  Decimal @default("0.00") @db.Decimal(10, 0) // Parte aplicada a capital (debe reducir remainingBalance)
  appliedToInterest Decimal @default("0.00") @db.Decimal(10, 0) // Parte aplicada a intereses (registro para reporting)
  appliedToLateFee  Decimal @default("0.00") @db.Decimal(10, 0) // Parte aplicada a mora (si procede)

  recordedByUserId Int? // Usuario que registró este pago (audit)
  recordedByUser   User? @relation("PaymentsRecordedByUser", fields: [recordedByUserId], references: [id])

  @@index([loanId])
  @@index([installmentId])
  @@index([paymentTypeId])
  @@index([collectorId])
  @@map("payments")
}

model Refinancing {
  id             Int   @id @default(autoincrement()) // PK refinanciamiento
  originalLoanId Int // FK al crédito original (antes de refinanciar)
  originalLoan   Loan  @relation("OriginalLoan", fields: [originalLoanId], references: [id])
  newLoanId      Int? // FK opcional al nuevo crédito (si se crea uno nuevo)
  newLoan        Loan? @relation("NewLoan", fields: [newLoanId], references: [id])

  // Campos que registran el estado antes y después (útiles para trazabilidad y reporting)
  oldPrincipal    Decimal  @db.Decimal(10, 0) // Principal antes del refinanciamiento
  oldRemaining    Decimal  @db.Decimal(10, 0) // Saldo restante antes
  newPrincipal    Decimal  @db.Decimal(10, 0) // Nuevo principal luego del ajuste
  newRemaining    Decimal  @db.Decimal(10, 0) // Nuevo saldo luego del ajuste
  oldInterestRate Decimal  @db.Decimal(6, 4) // Tasa anterior
  newInterestRate Decimal  @db.Decimal(6, 4) // Tasa nueva
  date            DateTime @default(now()) // Fecha del evento de refinanciación
  notes           String? // Observaciones

  @@index([originalLoanId])
  @@index([newLoanId])
  @@index([date])
  @@map("refinancings")
}
